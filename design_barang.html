<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Data Barang</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800" x-data="itemApp()">

    <!-- Navbar -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fa-solid fa-boxes-stacked text-blue-600 text-2xl mr-2"></i>
                        <span class="font-bold text-xl text-gray-800">InventarisApp - Data Barang</span>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold mr-2">
                        <span>A</span>
                    </div>
                    <span class="font-medium">Admin Gudang</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Daftar Barang</h1>
            <button @click="openModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center shadow-sm transition">
                <i class="fa-solid fa-plus mr-2"></i> Tambah Barang
            </button>
        </div>

        <!-- Filter & Search -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-3 md:space-y-0">
                <div class="flex-1">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-search text-gray-400"></i>
                        </div>
                        <input type="text" x-model="search" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Cari berdasarkan Kode atau Nama...">
                    </div>
                </div>
                <div>
                    <select x-model="filterCategory" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-lg">
                        <option value="">Semua Kategori</option>
                        <template x-for="cat in categories" :key="cat.id">
                            <option :value="cat.id" x-text="cat.name"></option>
                        </template>
                    </select>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Barang</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Varian (Size)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Stok</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Harga</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-if="filteredItems.length === 0">
                            <tr>
                                <td colspan="7" class="px-6 py-10 text-center text-gray-500">
                                    <p>Tidak ada data barang.</p>
                                </td>
                            </tr>
                        </template>
                        <template x-for="item in filteredItems" :key="item.id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="item.code"></td>
                                <td class="px-6 py-4">
                                    <div class="text-sm font-medium text-gray-900" x-text="item.name"></div>
                                    <div class="text-xs text-gray-500 truncate max-w-xs" x-text="item.description || '-'"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="getCategoryName(item.category_id)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <span x-show="item.sizes.length > 0" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800" x-text="item.size || 'Varian'"></span>
                                    <span x-show="item.sizes.length === 0" class="text-gray-400">-</span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <span class="text-sm font-bold text-gray-900 mr-1" x-text="item.stock"></span>
                                        <span class="text-xs text-gray-500" x-text="getUnitSymbol(item.unit_id)"></span>
                                    </div>
                                    <template x-if="item.stock < 10">
                                        <span class="text-xs text-red-600 font-medium">Stok Menipis!</span>
                                    </template>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right" x-text="formatRupiah(item.price)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                    <button @click="editItem(item)" class="text-indigo-600 hover:text-indigo-900 mr-3" title="Edit">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <button @click="deleteItem(item.id)" class="text-red-600 hover:text-red-900" title="Hapus">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- MODAL FORM -->
        <div x-show="isModalOpen" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true" x-cloak>
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div x-show="isModalOpen"
                     x-transition:enter="ease-out duration-300"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" @click="closeModal()"></div>

                <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

                <div x-show="isModalOpen"
                     x-transition:enter="ease-out duration-300"
                     x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave="ease-in duration-200"
                     x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full">

                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                <i class="fa-solid fa-box-open text-blue-600"></i>
                            </div>
                            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title" x-text="isEditMode ? 'Edit Barang' : 'Tambah Barang Baru'"></h3>

                                <form @submit.prevent="saveItem" class="mt-6 space-y-4">
                                    <!-- Kode & Kategori -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Kode Barang <span class="text-red-500">*</span></label>
                                            <input type="text" x-model="form.code" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 sm:text-sm" placeholder="Contoh: BRG-001">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Kategori <span class="text-red-500">*</span></label>
                                            <select x-model="form.category_id" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 sm:text-sm">
                                                <option value="">-- Pilih Kategori --</option>
                                                <template x-for="cat in categories" :key="cat.id">
                                                    <option :value="cat.id" x-text="cat.name"></option>
                                                </template>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Nama Barang -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Nama Barang <span class="text-red-500">*</span></label>
                                        <input type="text" x-model="form.name" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 sm:text-sm" placeholder="Contoh: Kertas A4">
                                    </div>

                                    <!-- Satuan & Harga -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Satuan <span class="text-red-500">*</span></label>
                                            <select x-model="form.unit_id" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 sm:text-sm">
                                                <option value="">-- Pilih Satuan --</option>
                                                <template x-for="unit in units" :key="unit.id">
                                                    <option :value="unit.id" x-text="unit.name + ' (' + unit.symbol + ')'"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Harga (Rp)</label>
                                            <input type="number" x-model="form.price" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 sm:text-sm" placeholder="0">
                                        </div>
                                    </div>

                                    <!-- Deskripsi -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Deskripsi</label>
                                        <textarea x-model="form.description" rows="2" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 sm:text-sm"></textarea>
                                    </div>

                                    <hr class="border-gray-200">

                                    <!-- VARIAN UKURAN & STOK -->
                                    <div>
                                        <div class="flex items-center justify-between mb-2">
                                            <label class="block text-base font-semibold text-gray-800">Manajemen Stok & Ukuran</label>
                                            <div class="flex items-center">
                                                <input type="checkbox" id="hasVariants" x-model="hasVariants" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                                <label for="hasVariants" class="ml-2 block text-sm text-gray-900">
                                                    Memiliki Varian Ukuran?
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Simple Stock Input -->
                                        <div x-show="!hasVariants" x-transition>
                                            <label class="block text-sm font-medium text-gray-700">Stok Barang</label>
                                            <input type="number" x-model="form.stock" class="mt-1 block w-full rounded-md border-gray-300 border p-2 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 sm:text-sm" placeholder="0">
                                            <p class="mt-1 text-xs text-gray-500">Masukkan jumlah stok total.</p>
                                        </div>

                                        <!-- Variant List -->
                                        <div x-show="hasVariants" x-transition class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                            <div class="mb-3 flex justify-between items-center">
                                                <span class="text-sm font-medium text-gray-700">Daftar Ukuran</span>
                                                <button type="button" @click="addVariant" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 font-medium">
                                                    + Tambah Ukuran
                                                </button>
                                            </div>

                                            <template x-if="form.sizes.length === 0">
                                                <p class="text-sm text-red-500 italic">Belum ada varian ukuran ditambahkan.</p>
                                            </template>

                                            <div class="space-y-2">
                                                <template x-for="(variant, index) in form.sizes" :key="index">
                                                    <div class="flex gap-2 items-center">
                                                        <input type="text" x-model="variant.size" class="flex-1 rounded-md border-gray-300 border p-2 text-sm" placeholder="Nama Ukuran (misal: XL)">
                                                        <input type="number" x-model="variant.stock" class="w-24 rounded-md border-gray-300 border p-2 text-sm" placeholder="Stok" min="0">
                                                        <button type="button" @click="removeVariant(index)" class="text-red-500 hover:text-red-700 p-2">
                                                            <i class="fa-solid fa-times"></i>
                                                        </button>
                                                    </div>
                                                </template>
                                            </div>

                                            <div class="mt-3 pt-2 border-t border-gray-200 flex justify-between items-center">
                                                <span class="text-sm font-bold text-gray-700">Total Stok Terhitung:</span>
                                                <span class="text-lg font-bold text-blue-600" x-text="calculateTotalVariantStock()"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pt-4 flex sm:flex-row-reverse">
                                        <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                            Simpan
                                        </button>
                                        <button type="button" @click="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                            Batal
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        function itemApp() {
            return {
                isModalOpen: false,
                isEditMode: false,
                search: '',
                filterCategory: '',
                hasVariants: false,

                // Mock Data
                categories: [
                    { id: 1, name: 'Elektronik' },
                    { id: 2, name: 'ATK' },
                    { id: 3, name: 'Pakaian' },
                    { id: 4, name: 'APD' }
                ],
                units: [
                    { id: 1, name: 'Unit', symbol: 'Unit' },
                    { id: 2, name: 'Pieces', symbol: 'Pcs' },
                    { id: 3, name: 'Rim', symbol: 'Rim' },
                    { id: 4, name: 'Pasang', symbol: 'Psg' }
                ],
                items: [
                    {
                        id: 101,
                        code: 'BRG-001',
                        name: 'Kertas A4',
                        size: null,
                        category_id: 2,
                        unit_id: 3,
                        stock: 50,
                        price: 45000,
                        description: 'Kertas HVS 70gsm',
                        sizes: []
                    },
                    {
                        id: 102,
                        code: 'BRG-002',
                        name: 'Seragam Dinas',
                        size: 'S, M, L',
                        category_id: 3,
                        unit_id: 2,
                        stock: 15,
                        price: 150000,
                        description: 'Seragam lapangan bahan drill',
                        sizes: [
                            { id: 1, size: 'S', stock: 5 },
                            { id: 2, size: 'M', stock: 8 },
                            { id: 3, size: 'L', stock: 2 }
                        ]
                    }
                ],

                form: {
                    id: null,
                    code: '',
                    name: '',
                    category_id: '',
                    unit_id: '',
                    stock: 0,
                    price: '',
                    description: '',
                    sizes: [] // Array of { size: '', stock: 0 }
                },

                // Computed
                get filteredItems() {
                    return this.items.filter(item => {
                        const matchesSearch = item.name.toLowerCase().includes(this.search.toLowerCase()) ||
                                            item.code.toLowerCase().includes(this.search.toLowerCase());
                        const matchesCategory = this.filterCategory === '' || item.category_id == this.filterCategory;
                        return matchesSearch && matchesCategory;
                    });
                },

                // Helpers
                getCategoryName(id) {
                    const c = this.categories.find(x => x.id == id);
                    return c ? c.name : '-';
                },
                getUnitSymbol(id) {
                    const u = this.units.find(x => x.id == id);
                    return u ? u.symbol : '';
                },
                formatRupiah(number) {
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(number);
                },

                calculateTotalVariantStock() {
                    if (!this.form.sizes || this.form.sizes.length === 0) return 0;
                    return this.form.sizes.reduce((acc, curr) => acc + (parseInt(curr.stock) || 0), 0);
                },

                generateSizeString(sizes) {
                    if (!sizes || sizes.length === 0) return null;
                    return sizes.map(s => s.size).join(', ');
                },

                // Actions
                openModal() {
                    this.isEditMode = false;
                    this.hasVariants = false;
                    this.form = {
                        id: null,
                        code: '',
                        name: '',
                        category_id: '',
                        unit_id: '',
                        stock: 0,
                        price: '',
                        description: '',
                        sizes: []
                    };
                    this.isModalOpen = true;
                },

                editItem(item) {
                    this.isEditMode = true;
                    this.hasVariants = item.sizes && item.sizes.length > 0;
                    // Deep copy to avoid direct mutation
                    this.form = JSON.parse(JSON.stringify(item));
                    this.isModalOpen = true;
                },

                closeModal() {
                    this.isModalOpen = false;
                },

                addVariant() {
                    this.form.sizes.push({ size: '', stock: 0 });
                },

                removeVariant(index) {
                    this.form.sizes.splice(index, 1);
                },

                saveItem() {
                    // Validation
                    if (!this.form.code || !this.form.name || !this.form.category_id || !this.form.unit_id) {
                        Swal.fire('Error', 'Harap isi semua field wajib (*)', 'error');
                        return;
                    }

                    if (this.hasVariants) {
                        if (this.form.sizes.length === 0) {
                            Swal.fire('Error', 'Anda memilih opsi varian, harap tambahkan minimal satu ukuran.', 'error');
                            return;
                        }
                        // Validate variant fields
                        for (let s of this.form.sizes) {
                            if (!s.size || s.stock === '') {
                                Swal.fire('Error', 'Nama ukuran dan stok varian tidak boleh kosong.', 'error');
                                return;
                            }
                        }
                        // Update total stock from variants
                        this.form.stock = this.calculateTotalVariantStock();
                        this.form.size = this.generateSizeString(this.form.sizes);
                    } else {
                        // Clear variants if switched off
                        this.form.sizes = [];
                        this.form.size = null;
                        this.form.stock = parseInt(this.form.stock) || 0;
                    }

                    if (this.isEditMode) {
                        const index = this.items.findIndex(i => i.id === this.form.id);
                        if (index !== -1) {
                            this.items[index] = { ...this.form };
                            Swal.fire('Berhasil', 'Data barang diperbarui', 'success');
                        }
                    } else {
                        const newItem = {
                            ...this.form,
                            id: Date.now(),
                        };
                        this.items.push(newItem);
                        Swal.fire('Berhasil', 'Barang baru ditambahkan', 'success');
                    }

                    this.closeModal();
                },

                deleteItem(id) {
                    Swal.fire({
                        title: 'Hapus Barang?',
                        text: "Data yang dihapus tidak dapat dikembalikan!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Ya, Hapus!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            this.items = this.items.filter(i => i.id !== id);
                            Swal.fire('Terhapus!', 'Data barang telah dihapus.', 'success');
                        }
                    });
                }
            };
        }
    </script>
</body>
</html>
